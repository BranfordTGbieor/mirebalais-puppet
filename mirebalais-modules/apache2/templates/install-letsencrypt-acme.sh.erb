#!/bin/bash

export EMRREPORTING='<%= @site_domain %>'

echo 'acme    ALL=(ALL) NOPASSWD: /usr/sbin/service apache2 restart' | sudo EDITOR='tee -a' visudo

sudo EMRREPORTING=$EMRREPORTING -s -u acme bash

rm -rf /var/acme/acme.sh
cd /var/acme
git clone https://github.com/acmesh-official/acme.sh.git
chown -R acme:acme /var/acme/acme.sh

su - acme
cd /var/acme/acme.sh
bash acme.sh --install
export AZUREDNS_SUBSCRIPTIONID='<%= @azure_dns_subscription_id %>'
export AZUREDNS_TENANTID='<%= @azure_dns_tenant_id %>'
export AZUREDNS_APPID='<%= @azure_dns_app_id %>'
export AZUREDNS_CLIENTSECRET='<%= @azure_dns_client_secret %>'
bash acme.sh --issue --dns dns_azure -d "$EMRREPORTING" --force
bash acme.sh --install-cert --domain "$EMRREPORTING" --cert-file /etc/letsencrypt/live/"$EMRREPORTING"/cert.pem --key-file /etc/letsencrypt/live/"$EMRREPORTING"/privkey.pem --fullchain-file /etc/letsencrypt/live/"$EMRREPORTING"/fullchain.pem --ca-file /etc/letsencrypt/live/"$EMRREPORTING"/chain.pem --reloadcmd "sudo /usr/sbin/service apache2 restart" --force
bash acme.sh --uninstall-cronjob --force